# myVentilator

Control temperature of the Sunshine Room at 10 Howard Street, Wenham, MA, USA by porting air from above a woodstove through a flexible duct into the ceiling of the sunshine room.

Sensors include room temperature mounted on the PLC about knee height, ambient air temperature from the internet, and plenum temperature in the ductwork above the woodstove.

Plenum temperature sensing serves two purposes:
    - inhibit air when it would exit the Sunshine room colder than the room itself, due to cold ambient air in the attic space
    - shutoff air when temperature is too high - i.e. a fire

There is a tachometer feedback signal available.  It's not used for anything but I ran wires for it in case.

There are two modes of control in the normal wired configuration. Both are demanded using a single pot mounted above the PLC in the Sunshine Room.  Clockwise increases closed-loop temperature control setpoint.  Counter-clocwise increases open-loop fan speed.  The mid-point of the pot is off.

The PLC uses the PWM method to produce an AC voltage that averages to a mean DC level as far as the motor circuits are concerned.

There are two motor in tandem to produce enough airflow for adequate flow.

The PLC is a Particle Photon.  This is the entry-level Particle device with WiFi connectivity. The code will port easily to any other Particle device.  It uses the Particle Workbench add-on to Visual Studio Code.  Follow the instructions by logging in here: https://docs.particle.io/quickstart/workbench/#linux


For installation of particle source, you either use GitHub desktop app to install or you click on the green '<> Code' box above to download a zip file (easiest).  [source](https://github.com/davegutz/myVentilator).   Move into the folder 'Documents/GitHub'

## Installation

Before going there, download the source code now because it's right at the top of this page:  click on the green box titled '<> Code' and 'Download ZIP' file.   Of course, you should skip this step if planning to use the 'GitHub Desktop App'.  Coming back here and locating the download will be difficult later and easy now.   The installation will explain what to do with the '.zip' file.

Python 3.6.8 is required for the _curl_ program needed to download data of the Particle cloud.

## Hardware notes

The PLC  mounted in Sunshine Room at knee level by window where Kathy's feet reside.  Most effective place to measure temperature.

The PWM signal from the PLC in the Sunshine Room goes up the 6-wire instrumentation line.   Not only unshielded by not possible to combine the PWM signals in twisted pairs.   So the Tp_Sense signal is corrupt unless PWM is off.   So every 30 minutes, which is about time constant of the wood stove, the application stops the blower to read Tp_Sense.

Potential solutions of PWM noise issue:
    separate shielded Tp_Sense wire.  Old antenna coax would be good for this.
    Separate shielded PWM signals line (the three POT signals: 10v, GND, 0-10v)

Grounds all tied together, so 0-10V signal can be generated by 0-3.3v PWM output of the PLC using 10V power source for PWM.

System gain ~3 deg F for 100% fan

~30 sec duct heat soak

~4500 sec room heat soak

### digipot not used
* Found MCP4151 POT how to at
  https://community.particle.io/t/photon-controlling-5v-output-using-mcp4151-pot-and-photon-spi-api/25001/2

* There is a POT library here.   Haven't used it yet
  https://github.com/jmalloc/arduino-mcp4xxx

### Note about ground
* For ICs to work, I believe ECMF B (ground) needs to be connected to
  Photon and IC ground.  Need to try this.  Will have to find an isolation scheme if this doesn't work,
  using ECMF 10V and it's ground for one supply and 5v and Photon for other.

### Pinout
* ECMF-150 remote brushless DC-motor fan. 300 mA max with auto protect.  (Photon is 1000 mA max)
  R Red wire 10V supply generated by ECMF to PWM Driver Circuit 210 ohm resistor-H
  B Black wire GND.   ????Don't know if this is earth.  I guess it floats.  Try tie to Photon
  C Blue wire 0-10V control signal used by ECMF to modulate fan speed 0-100%.   Can either be  
        1-10kHz PWM or 10K pot wiper connected H to R and L to B
  Y Tach signal 0-10V for 0-100%. Isink_max 10mA.  I don't know what that means.

* Pot Analog Connections
  POHa    ECMF R 10 V supply
  POWa    Photon A2 (BOM = ECMF C Blue Control Signal)
  POLa    System GND to GND Rail

* PWM Driver Circuit
  - npn1 (2n2222A)
    C - B of npn2 and L of 4k7 that goes to 10V
    B - H of 10k
    E - GND Rail
  - npn2 (2n2222A)
    C - ECMF C and diode anode?? and pullup that goes to 10V
    B - C of npn1 and 4k7 that goes to 10V
    E - GND Rail
  - pullup 4k7
    H - ECMF 10V
    L - C of npn2 and H of diode
  - 10k1 npn1 base driver
    H - Photon D2
    L - B of npn1
  - 10k2 npn2 base driver
    H - C of npn1
    L - B of npn2
  - diode (1N4148) signal diode to protect npn2 from load transients
    Anode?? - ECMF C
    Cathode?? - GND Rail

* Tach Voltage Divider Circuit
  - 200K ohm resistor
    H - ECMF Y - Tach
    L - Photon A8
  - 100K ohm resistor
    H - Photon A1
    L - Ground Rail

* Honeywell temp/humidity Hardware Connections (Humidistat with temp SOIC  HIH6131-021-001)
  Wire.h and I2C used.   
  Code originally developed for gitHub davegutz/myThermostat-Particle-Photon/myThermostat_Particle_DEV/myThermostat.ino.
  1-VCORE= 0.1uF jumper to GND
  2-VSS  = GND Rail
  3-SCL  = D1
  4-SCA  = D0
  5-AL_H = NC
  6-AL_L = NC
  7-NC   = NC
  8-VDD  = 3v3

* Particle Photon 1A max
* Particle Photon boards have 9 PWM pins: D0, D1, D2, D3, A4, A5, WKP, RX, TX
  GND = to 2 GND rails
  A1  = L of 200k ohm from ECMF Y Tach and H of 100k ohm to ground (0-3.3v from 0-10v)
  A2  = POWa of analog POT
  D0  = 4-SCA of Honeywell and 4k7 3v3 jumper I2C pullup
  D1  = 3-SCL of Honeywell and 4k7 3v3 jumper I2C pullup
  D2  = H of 10k1 for PWM 5kHz
  D6  = Y-C of DS18 for Tp and 4k7 3v3 jumper pullup
  VIN = 5V Rail 1A maximum and 0.1uF to GND and 100uF to GND
  3v3 = 3v3 rail out
  micro USB = Serial Monitor on PC (either Particle Workbench monitor or CoolTerm) 

* Voltage spike protection spec'd by Particle
  - 0.1uF
    H - VIN and 5V Rail
    L - GND Rail
  - 100uF
    H - VIN and 5V Rail
    L - GND Rail

* 1-wire Temp (MAXIM DS18B20)  library at https://github.com/particle-iot/OneWireLibrary
  Y-C   = Photon D6
  R-VDD = 5V Rail
  B-GND = GND Rail

* 5v
  5v to 5V Rail.  From wall wart in attic. 1 A max sized for Photon WiFi transients
  Gnd to GND Rail.   from wall wart in attic.  1 A max sized for Photon wifi transients

* *****not used Elego power module mounted to 5V and 3v3 and GND rails
  5V jumper = 5V RAIL on "A-side" of Photon
  Jumper "D-side" of Photon set to OFF
  Round power supply = round power supply plug 12 VDC x 1.0A Csec CS12b20100FUF
  

##  Debug data for 'proto'
  1.  Set debug = 2 in constants.h
  2.  Rebuild and upload to 'proto'
  3.  Start puTTY


## FAQ

### How do I run without the PLC

The box cover may be removed and wires connect completely to the potentiometer only for analog DC control.

If you consult the ECMF documentation you can figure it out along with the pinout diagrams.  Also look at the _jpg_ files in _Vent_Photon/datasheets_.  Basically, the potentiometer is connected so that the present PWM connections are replaced by a pot split voltage.

### The PLC is bright cyan and nothing is happening and there is no response to the potentiometer

First of all bright cyan if solid, not breathing, means connectivity error. Press the reset button using small dowel through the right-most hole high up on the front of the box.

### The PLC is breathing cyan but still nothing is happening

You need to get some internal data to see if anything is wrong. Usually the operating conditions are such that nothing should happen automatically. It should always respond to pot-only override.  In any case the data will confirm a problem. For auto mode problems usually the plenum temperature is not warm enough (>74 F) or sometimes Sunshine Room is above setpoint (62-68 F).

To gather data off the cloud, use the python program _Vent_Photon/dataReduction/curlParticle.py_ to stream some data into a csv file.  It uses the _curl_ program that works on python 3.6.8 or below.

If running the program appears not to work you probably need to update the cURL token _STREAM_URL_ embedded in the python code.  Particle resets them periodically for security reasons I suppose. To get the token:
    - login to particle.io (davegutz@alum.mit.edu, ste***) and get token:https://console.particle.io/devices/
    - click on device _vent_. It's icon should also be breathing blue. Click on the device.  The select the little square icon - looks like a play/record stop button - to view the token.   Copy token.  Paste into STREAM_URL below

Don't bother with the Scilab scripts.  The _curlParticle.py_ file has a header embedded in it that  you can paste to the top of a csv file and plot using _LibreOffice_ or _MSExcel_.

## Author:

Dave Gutz

davegutz@alum.mit.edu

## License

myVentilator's code are released under the MIT License.

See [LICENSE](https://github.com/openai/whisper/blob/main/LICENSE) for further details.
